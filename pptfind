#!/bin/sh
# recursive search in ppt 
VERSION=NA                                                                   
VERSION_DATE=NA

#check dependencies
if [ ! -e "/usr/bin/unoconv" ] 
then 
    echo "Not installed unoconv, exiting.."; 
    exit 1; 
fi

WHAT=$1
SEARCH_DIR=`pwd`
if [ "x$2" != "x" ]
then
    SEARCH_DIR=$2
fi

COLORS=
if [ -x /usr/bin/tput ] && tput setaf > /dev/null; then
    COLORS=" --color=always ";
fi

#alternative search using pptthml
#FILES=`find $SEARCH_DIR -type f -not -wholename "*\/.git*" |grep -i "\.ppt\$"`
#FILES_COUNT=`echo "$FILES" | wc -l `
#echo "searching '$WHAT' in $SEARCH_DIR  $FILES_COUNT ppt files "
#for FILE in $FILES ; do
#    RESULT=`/usr/bin/ppthtml $FILE | html2text |  grep $COLORS -E "$WHAT"`
#    if [ "$RESULT" != "" ] 
#    then
#      echo "$FILE: $RESULT";
#    fi
#done

FILES=$(find $SEARCH_DIR -type f -not -wholename "*\/.git*" -printf '%p\n' | grep -i -E -Z '\.(ppt|odp|pptx)$')
FILES_COUNT=`echo "$FILES" | grep -v '^$' | wc -l `
echo "searching '\033[32m$WHAT\033[0m' in \033[34m$SEARCH_DIR\033[0m \033[46m$FILES_COUNT ppt,pptx,odp\033[0m files"
echo "${FILES}" | while IFS='\n' read -r FILE ; do
    if [ ! -z `echo "$FILE" |grep -i ".pptx\$"` ];then
        #unpack to xml | remove tags | clean empty lines
        RESULT=`unzip -p $FILE | sed -e 's/<[^>]*>//g' | sed '/^\s*$/d' |  grep $COLORS -E "$WHAT"`
    else
        RESULT=`unoconv  -f xhtml --stdout $FILE  2> /dev/null | html2text |  grep $COLORS -E "$WHAT"`
    fi
    if [ "$RESULT" != "" ] 
    then
      echo "\033[34m$FILE\033[0m: $RESULT";
    fi
done


